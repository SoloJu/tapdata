package io.tapdata.flow.engine.V2.task.preview;

import com.tapdata.constant.BeanUtil;
import com.tapdata.tm.commons.task.dto.TaskDto;
import io.tapdata.flow.engine.V2.task.TaskClient;
import io.tapdata.flow.engine.V2.task.impl.HazelcastTaskService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;
import org.mockito.MockedStatic;

import java.util.ArrayList;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * @author samuel
 * @Description
 * @create 2024-11-06 17:23
 **/
@DisplayName("Class TaskPreviewService Test")
class TaskPreviewServiceTest {

	private TaskPreviewService taskPreviewService;

	@BeforeEach
	void setUp() {
		taskPreviewService = new TaskPreviewService();
		taskPreviewService = spy(taskPreviewService);
	}

	@Nested
	@DisplayName("Method preview test")
	class previewTest {
		@Test
		@DisplayName("test main process")
		void test1() {
			String taskJson = "{\"id\":\"66fa6374f4a38202d0ac65d0\",\"lastUpdBy\":\"62bc5008d4958d013d97c7a6\",\"createUser\":\"admin@admin.com\",\"permissionActions\":[\"View\",\"Edit\",\"Delete\",\"Reset\",\"Start\",\"Stop\"],\"deduplicWriteMode\":\"intelligent\",\"desc\":\"\",\"increHysteresis\":false,\"increOperationMode\":false,\"increSyncConcurrency\":false,\"processorThreadNum\":1,\"increaseReadSize\":1,\"readBatchSize\":500,\"writeBatchSize\":0,\"writeBatchWaitMs\":0,\"isAutoCreateIndex\":true,\"isFilter\":false,\"isOpenAutoDDL\":false,\"isSchedule\":false,\"isStopOnError\":true,\"name\":\"preview\",\"shareCdcEnable\":false,\"statuses\":[],\"status\":\"edit\",\"type\":\"initial_sync+cdc\",\"writeThreadSize\":8,\"editVersion\":\"1730886537373\",\"syncType\":\"sync\",\"transformProcess\":0,\"listtags\":[{\"id\":\"66ed36f0ef65292a71d427dd\",\"value\":\"preview\"}],\"planStartDateFlag\":false,\"accessNodeType\":\"AUTOMATIC_PLATFORM_ALLOCATION\",\"accessNodeProcessIdList\":[],\"accessNodeProcessId\":\"\",\"transformUuid\":\"1730886537384\",\"transformed\":true,\"transformDagHash\":0,\"enforceShareCdc\":true,\"pageVersion\":\"1730886507146\",\"dag\":{\"edges\":[{\"disabled\":false,\"source\":\"624e868d-419a-4693-9b71-e50c59b86bbf\",\"target\":\"7610a5af-7231-420b-a915-3ee01854b16c\"}],\"nodes\":[{\"tableName\":\"POLICY\",\"isFilter\":false,\"maxTransactionDuration\":12,\"existDataProcessMode\":\"keepData\",\"xmlIncludeFile\":false,\"esFragmentNum\":3,\"nodeConfig\":{\"hashSplit\":false,\"maxSplit\":20,\"batchReadThreadSize\":4},\"cdcMode\":\"logCdc\",\"cdcPollingFields\":[{\"field\":\"\",\"defaultValue\":\"\"}],\"cdcPollingInterval\":500,\"cdcPollingBatchSize\":1000,\"enableCustomCommand\":false,\"incrementExactlyOnceEnableTimeWindowDay\":3,\"connectionId\":\"6641e5fcdea40f2b5753b2e2\",\"databaseType\":\"Mysql\",\"ddlConfiguration\":\"FILTER\",\"readBatchSize\":100,\"increaseReadSize\":1,\"writeStrategy\":\"updateOrInsert\",\"type\":\"table\",\"catalog\":\"data\",\"isTransformed\":false,\"alarmSettings\":[{\"type\":\"DATANODE\",\"open\":true,\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"sort\":4,\"notify\":[\"SYSTEM\",\"EMAIL\"],\"interval\":300,\"unit\":\"SECOND\"}],\"alarmRules\":[{\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"point\":12,\"equalsFlag\":1,\"ms\":5000}],\"id\":\"624e868d-419a-4693-9b71-e50c59b86bbf\",\"name\":\"POLICY\",\"elementType\":\"Node\",\"attrs\":{\"position\":[50,50],\"connectionName\":\"mysql local INSURANCE\",\"connectionType\":\"source_and_target\",\"accessNodeProcessId\":\"\",\"pdkType\":\"pdk\",\"pdkHash\":\"a5af410b12afca476edf4a650c133ddf135bf76542a67787ed6f7f7d53ba712\",\"capabilities\":[{\"type\":11,\"id\":\"run_raw_command_function\"},{\"type\":11,\"id\":\"execute_command_function\"},{\"type\":11,\"id\":\"batch_read_function\"},{\"type\":11,\"id\":\"stream_read_function\"},{\"type\":11,\"id\":\"batch_count_function\"},{\"type\":11,\"id\":\"timestamp_to_stream_offset_function\"},{\"type\":11,\"id\":\"write_record_function\"},{\"type\":11,\"id\":\"query_by_advance_filter_function\"},{\"type\":11,\"id\":\"create_table_v2_function\"},{\"type\":11,\"id\":\"clear_table_function\"},{\"type\":11,\"id\":\"drop_table_function\"},{\"type\":11,\"id\":\"create_index_function\"},{\"type\":11,\"id\":\"query_indexes_function\"},{\"type\":11,\"id\":\"alter_field_attributes_function\"},{\"type\":11,\"id\":\"alter_field_name_function\"},{\"type\":11,\"id\":\"drop_field_function\"},{\"type\":11,\"id\":\"new_field_function\"},{\"type\":11,\"id\":\"count_by_partition_filter_function\"},{\"type\":11,\"id\":\"transaction_begin_function\"},{\"type\":11,\"id\":\"transaction_commit_function\"},{\"type\":11,\"id\":\"transaction_rollback_function\"},{\"type\":11,\"id\":\"get_table_info_function\"},{\"type\":11,\"id\":\"get_table_names_function\"},{\"type\":11,\"id\":\"error_handle_function\"},{\"type\":20,\"id\":\"dml_insert_policy\",\"alternatives\":[\"update_on_exists\",\"ignore_on_exists\",\"just_insert\"]},{\"type\":20,\"id\":\"dml_update_policy\",\"alternatives\":[\"ignore_on_nonexists\",\"insert_on_nonexists\"]},{\"type\":20,\"id\":\"api_server_supported\"},{\"type\":20,\"id\":\"source_incremental_update_event_have_before\"},{\"type\":20,\"id\":\"illegal_date_acceptable\"},{\"type\":20,\"id\":\"batch_read_hash_split\"},{\"type\":10,\"id\":\"new_field_event\"},{\"type\":10,\"id\":\"alter_field_name_event\"},{\"type\":10,\"id\":\"alter_field_attributes_event\"},{\"type\":10,\"id\":\"drop_field_event\"}],\"hasCreated\":false,\"accessNodeType\":\"AUTOMATIC_PLATFORM_ALLOCATION\"},\"disabled\":false},{\"tableName\":\"POLICY\",\"isFilter\":false,\"maxTransactionDuration\":12,\"existDataProcessMode\":\"keepData\",\"updateConditionFields\":[\"POLICY_ID\"],\"xmlIncludeFile\":false,\"esFragmentNum\":3,\"nodeConfig\":{\"syncIndex\":false,\"enableSaveDeleteData\":false,\"writeConcern\":\"w1\",\"shardCollection\":false,\"timeSeriesCollection\":false},\"cdcPollingInterval\":0,\"cdcPollingBatchSize\":0,\"enableCustomCommand\":false,\"incrementExactlyOnceEnableTimeWindowDay\":3,\"connectionId\":\"664c54f0601f4619dacca07b\",\"databaseType\":\"MongoDB\",\"dmlPolicy\":{\"insertPolicy\":\"update_on_exists\",\"updatePolicy\":\"ignore_on_nonexists\"},\"concurrentWritePartitionMap\":{},\"readBatchSize\":500,\"increaseReadSize\":1,\"writeBatchSize\":100,\"writeBatchWaitMs\":500,\"writeStrategy\":\"updateOrInsert\",\"uniqueIndexEnable\":true,\"noPkSyncMode\":\"ADD_HASH\",\"type\":\"table\",\"catalog\":\"data\",\"isTransformed\":false,\"alarmSettings\":[{\"type\":\"DATANODE\",\"open\":true,\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"sort\":4,\"notify\":[\"SYSTEM\",\"EMAIL\"],\"interval\":300,\"unit\":\"SECOND\"}],\"alarmRules\":[{\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"point\":12,\"equalsFlag\":1,\"ms\":5000}],\"id\":\"7610a5af-7231-420b-a915-3ee01854b16c\",\"name\":\"POLICY\",\"elementType\":\"Node\",\"attrs\":{\"position\":[334,50],\"connectionName\":\"mongo local target\",\"connectionType\":\"source_and_target\",\"accessNodeProcessId\":\"\",\"pdkType\":\"pdk\",\"pdkHash\":\"4335aaa005ec1a74a4e2166bded2962e939ad50239f48b023b884f35b54129a5\",\"capabilities\":[{\"type\":20,\"id\":\"source_incremental_update_event_have_before\"},{\"type\":11,\"id\":\"execute_command_function\"},{\"type\":11,\"id\":\"batch_read_function\"},{\"type\":11,\"id\":\"stream_read_function\"},{\"type\":11,\"id\":\"batch_count_function\"},{\"type\":11,\"id\":\"timestamp_to_stream_offset_function\"},{\"type\":11,\"id\":\"write_record_function\"},{\"type\":11,\"id\":\"query_by_advance_filter_function\"},{\"type\":11,\"id\":\"create_table_v2_function\"},{\"type\":11,\"id\":\"drop_table_function\"},{\"type\":11,\"id\":\"create_index_function\"},{\"type\":11,\"id\":\"query_indexes_function\"},{\"type\":11,\"id\":\"count_by_partition_filter_function\"},{\"type\":11,\"id\":\"get_read_partitions_function\"},{\"type\":11,\"id\":\"query_field_min_max_value_function\"},{\"type\":11,\"id\":\"get_table_info_function\"},{\"type\":11,\"id\":\"get_table_names_function\"},{\"type\":11,\"id\":\"error_handle_function\"},{\"type\":20,\"id\":\"master_slave_merge\"},{\"type\":20,\"id\":\"dynamic_schema\"},{\"type\":20,\"id\":\"dml_insert_policy\",\"alternatives\":[\"update_on_exists\",\"ignore_on_exists\"]},{\"type\":20,\"id\":\"dml_update_policy\",\"alternatives\":[\"ignore_on_nonexists\",\"insert_on_nonexists\",\"log_on_nonexists\"]},{\"type\":20,\"id\":\"api_server_supported\"}],\"db_version\":\"7.0.5\",\"hasCreated\":true,\"accessNodeType\":\"AUTOMATIC_PLATFORM_ALLOCATION\"},\"disabled\":false}]},\"shareCache\":false,\"canOpenInspect\":false,\"isAutoInspect\":false,\"creator\":\"admin@admin.com\",\"showInspectTips\":false,\"alarmSettings\":[{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_STATUS_ERROR\",\"sort\":1,\"notify\":[\"SYSTEM\",\"EMAIL\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_FULL_COMPLETE\",\"sort\":3,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_INCREMENT_START\",\"sort\":4,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_INCREMENT_DELAY\",\"sort\":6,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"}],\"alarmRules\":[{\"key\":\"TASK_INCREMENT_DELAY\",\"point\":60,\"equalsFlag\":1,\"ms\":60000}],\"testTaskId\":\"66fa6374f4a38202d0ac65ce\",\"transformTaskId\":\"66fa6374f4a38202d0ac65cf\",\"stopRetryTimes\":0,\"delayTime\":0,\"doubleActive\":false,\"errorEvents\":[{\"id\":\"6704b527a52d08e5360374d7\",\"message\":\"java.lang.NullPointerException\",\"code\":\"11016\",\"skip\":false},{\"id\":\"67079366a276dd483b17044a\",\"message\":\"Unknown PDK exception occur, java.lang.RuntimeException: Find schema failed, message: Table name \\\"a22f85d3-096e-4656-a7fb-6370008faeff\\\" not exists, qualified name: null tableNameAndQualifiedNameMap: {POLICY=PN_a22f85d3-096e-4656-a7fb-6370008faeff}\",\"code\":\"18001\",\"skip\":false},{\"id\":\"671a2f087962bf68901c9875\",\"message\":\"java.lang.NullPointerException\",\"code\":\"37002\",\"skip\":false}],\"oldVersionTimezone\":false,\"timeDifference\":0,\"autoInspect\":false,\"testTask\":false,\"cdctask\":false,\"snapShotInterrupt\":false,\"previewTask\":false,\"deduceSchemaTask\":false,\"normalTask\":true,\"_deleted\":false,\"createTime\":\"2024-09-30T08:38:12.742+00:00\",\"last_updated\":\"2024-11-06T09:48:57.537+00:00\",\"user_id\":\"62bc5008d4958d013d97c7a6\"}\\\"a22f85d3-096e-4656-a7fb-6370008faeff\\\" not exists, qualified name: null tableNameAndQualifiedNameMap: {POLICY=PN_a22f85d3-096e-4656-a7fb-6370008faeff}\",\"code\":\"18001\",\"skip\":false},{\"id\":\"671a2f087962bf68901c9875\",\"message\":\"java.lang.NullPointerException\",\"code\":\"37002\",\"stacks\":\"java.lang.NullPointerException\\n\\tat io.tapdata.flow.engine.V2.task.preview.node.HazelcastPreviewSourcePdkDataNode.read(HazelcastPreviewSourcePdkDataNode.java:143)\\n\\tat io.tapdata.entity.simplify.pretty.ClassHandlersV2.handle(ClassHandlersV2.java:31)\\n\\tat io.tapdata.flow.engine.V2.task.preview.node.HazelcastPreviewSourcePdkDataNode.startSourceRunner(HazelcastPreviewSourcePdkDataNode.java:204)\\n\\tat java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)\\n\\tat java.base/java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:264)\\n\\tat java.base/java.util.concurrent.FutureTask.run(FutureTask.java)\\n\\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\\n\\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\\n\\tat java.base/java.lang.Thread.run(Thread.java:829)\\nCaused by: java.lang.NullPointerException\\n\\tat io.tapdata.connector.mysql.MysqlConnector.lambda$dateFields$18(MysqlConnector.java:666)\\n\\tat java.base/java.util.LinkedHashMap.forEach(LinkedHashMap.java:684)\\n\\tat io.tapdata.connector.mysql.MysqlConnector.dateFields(MysqlConnector.java:665)\\n\\tat io.tapdata.connector.mysql.MysqlConnector.lambda$queryByAdvanceFilterWithOffset$17(MysqlConnector.java:647)\\n\\tat io.tapdata.common.JdbcContext.query(JdbcContext.java:97)\\n\\tat io.tapdata.connector.mysql.MysqlConnector.queryByAdvanceFilterWithOffset(MysqlConnector.java:644)\\n\\tat io.tapdata.flow.engine.V2.task.preview.node.HazelcastPreviewSourcePdkDataNode.read(HazelcastPreviewSourcePdkDataNode.java:125)\\n\\t... 8 more\\n\",\"skip\":false}],\"oldVersionTimezone\":false,\"autoInspect\":false,\"testTask\":false,\"cdctask\":false,\"snapShotInterrupt\":false,\"previewTask\":false,\"deduceSchemaTask\":false,\"normalTask\":true,\"_deleted\":false,\"createTime\":\"2024-09-30T08:38:12.742+00:00\",\"last_updated\":\"2024-11-06T09:26:42.821+00:00\",\"user_id\":\"62bc5008d4958d013d97c7a6\"}";
			List<String> includeNodeIds = new ArrayList<>();
			includeNodeIds.add("7610a5af-7231-420b-a915-3ee01854b16c");
			includeNodeIds.add("624e868d-419a-4693-9b71-e50c59b86bbf");
			doAnswer(invocationOnMock -> null).when(taskPreviewService).previewPrivate(any(), any());
			doAnswer(invocationOnMock -> null).when(taskPreviewService).clearAfterPreview(any());
			TaskPreviewResultVO taskPreviewResultVO = assertDoesNotThrow(() -> taskPreviewService.preview(taskJson, includeNodeIds, 1));
			assertEquals(200, taskPreviewResultVO.getCode());
			assertNull(taskPreviewResultVO.getErrorMsg());
			assertNotNull(taskPreviewResultVO.getStats());
		}

		@Test
		@DisplayName("test parse task failed")
		void test2() {
			String taskJson = "\"id\":\"66fa6374f4a38202d0ac65d0\",\"lastUpdBy\":\"62bc5008d4958d013d97c7a6\",\"createUser\":\"admin@admin.com\",\"deduplicWriteMode\":\"intelligent\",\"desc\":\"\",\"increHysteresis\":false,\"increOperationMode\":false,\"increSyncConcurrency\":false,\"processorThreadNum\":1,\"increaseReadSize\":1,\"readBatchSize\":500,\"writeBatchSize\":0,\"writeBatchWaitMs\":0,\"isAutoCreateIndex\":true,\"isFilter\":false,\"isOpenAutoDDL\":false,\"isSchedule\":false,\"isStopOnError\":true,\"name\":\"preview\",\"shareCdcEnable\":false,\"statuses\":[],\"status\":\"edit\",\"type\":\"initial_sync+cdc\",\"writeThreadSize\":8,\"editVersion\":\"1730885202818\",\"syncType\":\"sync\",\"transformProcess\":0,\"listtags\":[{\"id\":\"66ed36f0ef65292a71d427dd\",\"value\":\"preview\"}],\"planStartDateFlag\":false,\"accessNodeType\":\"AUTOMATIC_PLATFORM_ALLOCATION\",\"accessNodeProcessIdList\":[],\"accessNodeProcessId\":\"\",\"transformUuid\":\"1730885202180\",\"transformed\":true,\"transformDagHash\":0,\"enforceShareCdc\":true,\"pageVersion\":\"1730885195827\",\"dag\":{\"edges\":[],\"nodes\":[{\"tableName\":\"POLICY\",\"isFilter\":false,\"maxTransactionDuration\":12,\"existDataProcessMode\":\"keepData\",\"xmlIncludeFile\":false,\"esFragmentNum\":3,\"nodeConfig\":{\"hashSplit\":false,\"maxSplit\":20,\"batchReadThreadSize\":4},\"cdcMode\":\"logCdc\",\"cdcPollingFields\":[{\"field\":\"\",\"defaultValue\":\"\"}],\"cdcPollingInterval\":500,\"cdcPollingBatchSize\":1000,\"enableCustomCommand\":false,\"incrementExactlyOnceEnableTimeWindowDay\":3,\"connectionId\":\"6641e5fcdea40f2b5753b2e2\",\"databaseType\":\"Mysql\",\"ddlConfiguration\":\"FILTER\",\"readBatchSize\":100,\"increaseReadSize\":1,\"writeStrategy\":\"updateOrInsert\",\"type\":\"table\",\"catalog\":\"data\",\"isTransformed\":false,\"alarmSettings\":[{\"type\":\"DATANODE\",\"open\":true,\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"sort\":4,\"notify\":[\"SYSTEM\",\"EMAIL\"],\"interval\":300,\"unit\":\"SECOND\"}],\"alarmRules\":[{\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"point\":12,\"equalsFlag\":1,\"ms\":5000}],\"id\":\"624e868d-419a-4693-9b71-e50c59b86bbf\",\"name\":\"POLICY\",\"elementType\":\"Node\",\"attrs\":{\"position\":[50,50],\"connectionName\":\"mysql local INSURANCE\",\"connectionType\":\"source_and_target\",\"accessNodeProcessId\":\"\",\"pdkType\":\"pdk\",\"pdkHash\":\"a5af410b12afca476edf4a650c133ddf135bf76542a67787ed6f7f7d53ba712\",\"capabilities\":[{\"type\":11,\"id\":\"run_raw_command_function\"},{\"type\":11,\"id\":\"execute_command_function\"},{\"type\":11,\"id\":\"batch_read_function\"},{\"type\":11,\"id\":\"stream_read_function\"},{\"type\":11,\"id\":\"batch_count_function\"},{\"type\":11,\"id\":\"timestamp_to_stream_offset_function\"},{\"type\":11,\"id\":\"write_record_function\"},{\"type\":11,\"id\":\"query_by_advance_filter_function\"},{\"type\":11,\"id\":\"create_table_v2_function\"},{\"type\":11,\"id\":\"clear_table_function\"},{\"type\":11,\"id\":\"drop_table_function\"},{\"type\":11,\"id\":\"create_index_function\"},{\"type\":11,\"id\":\"query_indexes_function\"},{\"type\":11,\"id\":\"alter_field_attributes_function\"},{\"type\":11,\"id\":\"alter_field_name_function\"},{\"type\":11,\"id\":\"drop_field_function\"},{\"type\":11,\"id\":\"new_field_function\"},{\"type\":11,\"id\":\"count_by_partition_filter_function\"},{\"type\":11,\"id\":\"transaction_begin_function\"},{\"type\":11,\"id\":\"transaction_commit_function\"},{\"type\":11,\"id\":\"transaction_rollback_function\"},{\"type\":11,\"id\":\"get_table_info_function\"},{\"type\":11,\"id\":\"get_table_names_function\"},{\"type\":11,\"id\":\"error_handle_function\"},{\"type\":20,\"id\":\"dml_insert_policy\",\"alternatives\":[\"update_on_exists\",\"ignore_on_exists\",\"just_insert\"]},{\"type\":20,\"id\":\"dml_update_policy\",\"alternatives\":[\"ignore_on_nonexists\",\"insert_on_nonexists\"]},{\"type\":20,\"id\":\"api_server_supported\"},{\"type\":20,\"id\":\"source_incremental_update_event_have_before\"},{\"type\":20,\"id\":\"illegal_date_acceptable\"},{\"type\":20,\"id\":\"batch_read_hash_split\"},{\"type\":10,\"id\":\"new_field_event\"},{\"type\":10,\"id\":\"alter_field_name_event\"},{\"type\":10,\"id\":\"alter_field_attributes_event\"},{\"type\":10,\"id\":\"drop_field_event\"}],\"hasCreated\":false,\"accessNodeType\":\"AUTOMATIC_PLATFORM_ALLOCATION\"},\"disabled\":false}]},\"shareCache\":false,\"canOpenInspect\":false,\"isAutoInspect\":false,\"showInspectTips\":false,\"alarmSettings\":[{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_STATUS_ERROR\",\"sort\":1,\"notify\":[\"SYSTEM\",\"EMAIL\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_FULL_COMPLETE\",\"sort\":3,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_INCREMENT_START\",\"sort\":4,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_INCREMENT_DELAY\",\"sort\":6,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"}],\"alarmRules\":[{\"key\":\"TASK_INCREMENT_DELAY\",\"point\":60,\"equalsFlag\":1,\"ms\":60000}],\"testTaskId\":\"66fa6374f4a38202d0ac65ce\",\"transformTaskId\":\"66fa6374f4a38202d0ac65cf\",\"stopRetryTimes\":0,\"delayTime\":0,\"doubleActive\":false,\"errorEvents\":[{\"id\":\"6704b527a52d08e5360374d7\",\"message\":\"java.lang.NullPointerException\",\"code\":\"11016\",\"skip\":false},{\"id\":\"67079366a276dd483b17044a\",\"message\":\"Unknown PDK exception occur, java.lang.RuntimeException: Find schema failed, message: Table name \\\"a22f85d3-096e-4656-a7fb-6370008faeff\\\" not exists, qualified name: null tableNameAndQualifiedNameMap: {POLICY=PN_a22f85d3-096e-4656-a7fb-6370008faeff}\",\"code\":\"18001\",\"skip\":false},{\"id\":\"671a2f087962bf68901c9875\",\"message\":\"java.lang.NullPointerException\",\"code\":\"37002\",\"stacks\":\"java.lang.NullPointerException\\n\\tat io.tapdata.flow.engine.V2.task.preview.node.HazelcastPreviewSourcePdkDataNode.read(HazelcastPreviewSourcePdkDataNode.java:143)\\n\\tat io.tapdata.entity.simplify.pretty.ClassHandlersV2.handle(ClassHandlersV2.java:31)\\n\\tat io.tapdata.flow.engine.V2.task.preview.node.HazelcastPreviewSourcePdkDataNode.startSourceRunner(HazelcastPreviewSourcePdkDataNode.java:204)\\n\\tat java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)\\n\\tat java.base/java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:264)\\n\\tat java.base/java.util.concurrent.FutureTask.run(FutureTask.java)\\n\\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\\n\\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\\n\\tat java.base/java.lang.Thread.run(Thread.java:829)\\nCaused by: java.lang.NullPointerException\\n\\tat io.tapdata.connector.mysql.MysqlConnector.lambda$dateFields$18(MysqlConnector.java:666)\\n\\tat java.base/java.util.LinkedHashMap.forEach(LinkedHashMap.java:684)\\n\\tat io.tapdata.connector.mysql.MysqlConnector.dateFields(MysqlConnector.java:665)\\n\\tat io.tapdata.connector.mysql.MysqlConnector.lambda$queryByAdvanceFilterWithOffset$17(MysqlConnector.java:647)\\n\\tat io.tapdata.common.JdbcContext.query(JdbcContext.java:97)\\n\\tat io.tapdata.connector.mysql.MysqlConnector.queryByAdvanceFilterWithOffset(MysqlConnector.java:644)\\n\\tat io.tapdata.flow.engine.V2.task.preview.node.HazelcastPreviewSourcePdkDataNode.read(HazelcastPreviewSourcePdkDataNode.java:125)\\n\\t... 8 more\\n\",\"skip\":false}],\"oldVersionTimezone\":false,\"autoInspect\":false,\"testTask\":false,\"cdctask\":false,\"snapShotInterrupt\":false,\"previewTask\":false,\"deduceSchemaTask\":false,\"normalTask\":true,\"_deleted\":false,\"createTime\":\"2024-09-30T08:38:12.742+00:00\",\"last_updated\":\"2024-11-06T09:26:42.821+00:00\",\"user_id\":\"62bc5008d4958d013d97c7a6\"}";
			List<String> includeNodeIds = new ArrayList<>();
			doAnswer(invocationOnMock -> null).when(taskPreviewService).previewPrivate(any(), any());
			doAnswer(invocationOnMock -> null).when(taskPreviewService).clearAfterPreview(any());
			TaskPreviewResultVO taskPreviewResultVO = assertDoesNotThrow(() -> taskPreviewService.preview(taskJson, includeNodeIds, 1));
			assertEquals(500, taskPreviewResultVO.getCode());
			assertNotNull(taskPreviewResultVO.getErrorMsg());
			assertNull(taskPreviewResultVO.getStats());
		}

		@Test
		@DisplayName("test migrate task")
		void test3() {
			String taskJson = "{\"id\":\"672b38f65bc90e11c98c4fde\",\"lastUpdBy\":\"62bc5008d4958d013d97c7a6\",\"createUser\":\"admin@admin.com\",\"permissionActions\":[\"View\",\"Edit\",\"Delete\",\"Reset\",\"Start\",\"Stop\"],\"deduplicWriteMode\":\"intelligent\",\"desc\":\"\",\"increHysteresis\":false,\"increOperationMode\":false,\"increSyncConcurrency\":false,\"processorThreadNum\":1,\"increaseReadSize\":1,\"readBatchSize\":500,\"writeBatchSize\":0,\"writeBatchWaitMs\":0,\"isAutoCreateIndex\":true,\"isFilter\":false,\"isOpenAutoDDL\":false,\"isSchedule\":false,\"isStopOnError\":true,\"name\":\"任务 42\",\"shareCdcEnable\":false,\"statuses\":[],\"status\":\"edit\",\"type\":\"initial_sync+cdc\",\"writeThreadSize\":8,\"editVersion\":\"1730885890216\",\"syncType\":\"migrate\",\"transformProcess\":0,\"planStartDateFlag\":false,\"accessNodeType\":\"AUTOMATIC_PLATFORM_ALLOCATION\",\"accessNodeProcessIdList\":[],\"accessNodeProcessId\":\"\",\"transformUuid\":\"1730885890255\",\"transformed\":true,\"transformDagHash\":0,\"enforceShareCdc\":true,\"pageVersion\":\"1730885191594\",\"dag\":{\"edges\":[{\"disabled\":false,\"source\":\"6745a263-09f9-49b2-8428-4a91ce6bf6a7\",\"target\":\"205b3207-64b5-4ad3-827c-cb0bb8e2124e\"}],\"nodes\":[{\"existDataProcessMode\":\"keepData\",\"tableNames\":[\"CAR_CLAIM\",\"CAR_CUSTOMER\",\"CAR_POLICY\"],\"migrateTableSelectType\":\"custom\",\"tableExpression\":\".*\",\"noPrimaryKeyTableSelectType\":\"HasKeys\",\"nodeConfig\":{\"hashSplit\":false,\"maxSplit\":20,\"batchReadThreadSize\":4,\"maximumQueueSize\":800},\"enableConcurrentRead\":false,\"concurrentReadThreadNumber\":0,\"connectionId\":\"6641e5fcdea40f2b5753b2e2\",\"databaseType\":\"Mysql\",\"ddlConfiguration\":\"FILTER\",\"readBatchSize\":100,\"increaseReadSize\":1,\"writeStrategy\":\"updateOrInsert\",\"noPkSyncMode\":\"ADD_HASH\",\"type\":\"database\",\"catalog\":\"data\",\"isTransformed\":false,\"alarmSettings\":[{\"type\":\"DATANODE\",\"open\":true,\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"sort\":4,\"notify\":[\"SYSTEM\",\"EMAIL\"],\"interval\":300,\"unit\":\"SECOND\"}],\"alarmRules\":[{\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"point\":12,\"equalsFlag\":1,\"ms\":5000}],\"id\":\"6745a263-09f9-49b2-8428-4a91ce6bf6a7\",\"name\":\"mysql local INSURANCE\",\"elementType\":\"Node\",\"attrs\":{\"position\":[-162,297],\"connectionName\":\"mysql local INSURANCE\",\"connectionType\":\"source_and_target\",\"accessNodeProcessId\":\"\",\"pdkType\":\"pdk\",\"pdkHash\":\"a5af410b12afca476edf4a650c133ddf135bf76542a67787ed6f7f7d53ba712\",\"capabilities\":[{\"type\":11,\"id\":\"run_raw_command_function\"},{\"type\":11,\"id\":\"execute_command_function\"},{\"type\":11,\"id\":\"batch_read_function\"},{\"type\":11,\"id\":\"stream_read_function\"},{\"type\":11,\"id\":\"batch_count_function\"},{\"type\":11,\"id\":\"timestamp_to_stream_offset_function\"},{\"type\":11,\"id\":\"write_record_function\"},{\"type\":11,\"id\":\"query_by_advance_filter_function\"},{\"type\":11,\"id\":\"create_table_v2_function\"},{\"type\":11,\"id\":\"clear_table_function\"},{\"type\":11,\"id\":\"drop_table_function\"},{\"type\":11,\"id\":\"create_index_function\"},{\"type\":11,\"id\":\"query_indexes_function\"},{\"type\":11,\"id\":\"alter_field_attributes_function\"},{\"type\":11,\"id\":\"alter_field_name_function\"},{\"type\":11,\"id\":\"drop_field_function\"},{\"type\":11,\"id\":\"new_field_function\"},{\"type\":11,\"id\":\"count_by_partition_filter_function\"},{\"type\":11,\"id\":\"transaction_begin_function\"},{\"type\":11,\"id\":\"transaction_commit_function\"},{\"type\":11,\"id\":\"transaction_rollback_function\"},{\"type\":11,\"id\":\"get_table_info_function\"},{\"type\":11,\"id\":\"get_table_names_function\"},{\"type\":11,\"id\":\"error_handle_function\"},{\"type\":20,\"id\":\"dml_insert_policy\",\"alternatives\":[\"update_on_exists\",\"ignore_on_exists\",\"just_insert\"]},{\"type\":20,\"id\":\"dml_update_policy\",\"alternatives\":[\"ignore_on_nonexists\",\"insert_on_nonexists\"]},{\"type\":20,\"id\":\"api_server_supported\"},{\"type\":20,\"id\":\"source_incremental_update_event_have_before\"},{\"type\":20,\"id\":\"illegal_date_acceptable\"},{\"type\":20,\"id\":\"batch_read_hash_split\"},{\"type\":10,\"id\":\"new_field_event\"},{\"type\":10,\"id\":\"alter_field_name_event\"},{\"type\":10,\"id\":\"alter_field_attributes_event\"},{\"type\":10,\"id\":\"drop_field_event\"},{\"type\":11,\"id\":\"query_hash_by_advance_filter_function\"}],\"accessNodeType\":\"AUTOMATIC_PLATFORM_ALLOCATION\"},\"disabled\":false},{\"existDataProcessMode\":\"keepData\",\"syncObjects\":[{\"type\":\"table\",\"objectNames\":[\"CAR_CLAIM\",\"CAR_CUSTOMER\",\"CAR_POLICY\"],\"tableNameRelation\":{\"CAR_CLAIM\":\"CAR_CLAIM\",\"CAR_CUSTOMER\":\"CAR_CUSTOMER\",\"CAR_POLICY\":\"CAR_POLICY\"}}],\"migrateTableSelectType\":\"custom\",\"nodeConfig\":{\"syncIndex\":false,\"enableSaveDeleteData\":false,\"enableFillingModifiedData\":true,\"noCursorTimeout\":false,\"skipDeletedEventsOnFilling\":true,\"preImage\":false,\"writeConcern\":\"w1\",\"shardCollection\":false,\"timeSeriesCollection\":false},\"updateConditionFieldMap\":{},\"enableConcurrentRead\":false,\"concurrentReadThreadNumber\":0,\"connectionId\":\"63468098c87faf3ba64fece0\",\"databaseType\":\"MongoDB\",\"readBatchSize\":500,\"increaseReadSize\":1,\"writeStrategy\":\"updateOrInsert\",\"noPkSyncMode\":\"ADD_HASH\",\"type\":\"database\",\"catalog\":\"data\",\"isTransformed\":false,\"alarmSettings\":[{\"type\":\"DATANODE\",\"open\":true,\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"sort\":4,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"}],\"alarmRules\":[{\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"point\":12,\"equalsFlag\":1,\"ms\":5000}],\"id\":\"205b3207-64b5-4ad3-827c-cb0bb8e2124e\",\"name\":\"S Agent Local DaaS_1\",\"elementType\":\"Node\",\"attrs\":{\"position\":[164,297],\"connectionName\":\"S Agent Local DaaS_1\",\"connectionType\":\"source_and_target\",\"accessNodeProcessId\":\"\",\"pdkType\":\"pdk\",\"pdkHash\":\"4335aaa005ec1a74a4e2166bded2962e939ad50239f48b023b884f35b54129a5\",\"capabilities\":[{\"type\":20,\"id\":\"source_incremental_update_event_have_before\"},{\"type\":11,\"id\":\"execute_command_function\"},{\"type\":11,\"id\":\"batch_read_function\"},{\"type\":11,\"id\":\"stream_read_function\"},{\"type\":11,\"id\":\"batch_count_function\"},{\"type\":11,\"id\":\"timestamp_to_stream_offset_function\"},{\"type\":11,\"id\":\"write_record_function\"},{\"type\":11,\"id\":\"query_by_advance_filter_function\"},{\"type\":11,\"id\":\"create_table_v2_function\"},{\"type\":11,\"id\":\"drop_table_function\"},{\"type\":11,\"id\":\"create_index_function\"},{\"type\":11,\"id\":\"query_indexes_function\"},{\"type\":11,\"id\":\"count_by_partition_filter_function\"},{\"type\":11,\"id\":\"get_read_partitions_function\"},{\"type\":11,\"id\":\"query_field_min_max_value_function\"},{\"type\":11,\"id\":\"get_table_info_function\"},{\"type\":11,\"id\":\"get_table_names_function\"},{\"type\":11,\"id\":\"error_handle_function\"},{\"type\":20,\"id\":\"master_slave_merge\"},{\"type\":20,\"id\":\"dynamic_schema\"},{\"type\":20,\"id\":\"dml_insert_policy\",\"alternatives\":[\"update_on_exists\",\"ignore_on_exists\"]},{\"type\":20,\"id\":\"dml_update_policy\",\"alternatives\":[\"ignore_on_nonexists\",\"insert_on_nonexists\",\"log_on_nonexists\"]},{\"type\":20,\"id\":\"api_server_supported\"}]},\"disabled\":false}]},\"shareCache\":false,\"canOpenInspect\":false,\"isAutoInspect\":false,\"creator\":\"admin@admin.com\",\"showInspectTips\":false,\"alarmSettings\":[{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_STATUS_ERROR\",\"sort\":1,\"notify\":[\"SYSTEM\",\"EMAIL\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_FULL_COMPLETE\",\"sort\":3,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_INCREMENT_START\",\"sort\":4,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_INCREMENT_DELAY\",\"sort\":6,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"}],\"alarmRules\":[{\"key\":\"TASK_INCREMENT_DELAY\",\"point\":60,\"equalsFlag\":1,\"ms\":60000}],\"testTaskId\":\"672b38f65bc90e11c98c4fdc\",\"transformTaskId\":\"672b38f65bc90e11c98c4fdd\",\"stopRetryTimes\":0,\"delayTime\":0,\"doubleActive\":false,\"oldVersionTimezone\":false,\"timeDifference\":0,\"autoInspect\":false,\"testTask\":false,\"cdctask\":false,\"snapShotInterrupt\":false,\"previewTask\":false,\"deduceSchemaTask\":false,\"normalTask\":true,\"_deleted\":false,\"createTime\":\"2024-11-06T09:37:58.489+00:00\",\"last_updated\":\"2024-11-06T09:38:10.493+00:00\",\"user_id\":\"62bc5008d4958d013d97c7a6\"}";
			List<String> includeNodeIds = new ArrayList<>();
			doAnswer(invocationOnMock -> null).when(taskPreviewService).previewPrivate(any(), any());
			doAnswer(invocationOnMock -> null).when(taskPreviewService).clearAfterPreview(any());
			TaskPreviewResultVO taskPreviewResultVO = assertDoesNotThrow(() -> taskPreviewService.preview(taskJson, includeNodeIds, 1));
			assertEquals(422, taskPreviewResultVO.getCode());
			assertNotNull(taskPreviewResultVO.getErrorMsg());
			assertNull(taskPreviewResultVO.getStats());
		}

		@Test
		@DisplayName("test task's nodes is empty")
		void test4() {
			String taskJson = "{\"id\":\"66fa6374f4a38202d0ac65d0\",\"lastUpdBy\":\"62bc5008d4958d013d97c7a6\",\"createUser\":\"admin@admin.com\",\"permissionActions\":[\"View\",\"Edit\",\"Delete\",\"Reset\",\"Start\",\"Stop\"],\"deduplicWriteMode\":\"intelligent\",\"desc\":\"\",\"increHysteresis\":false,\"increOperationMode\":false,\"increSyncConcurrency\":false,\"processorThreadNum\":1,\"increaseReadSize\":1,\"readBatchSize\":500,\"writeBatchSize\":0,\"writeBatchWaitMs\":0,\"isAutoCreateIndex\":true,\"isFilter\":false,\"isOpenAutoDDL\":false,\"isSchedule\":false,\"isStopOnError\":true,\"name\":\"preview\",\"shareCdcEnable\":false,\"statuses\":[],\"status\":\"edit\",\"type\":\"initial_sync+cdc\",\"writeThreadSize\":8,\"editVersion\":\"1730885202818\",\"syncType\":\"sync\",\"transformProcess\":0,\"listtags\":[{\"id\":\"66ed36f0ef65292a71d427dd\",\"value\":\"preview\"}],\"planStartDateFlag\":false,\"accessNodeType\":\"AUTOMATIC_PLATFORM_ALLOCATION\",\"accessNodeProcessIdList\":[],\"accessNodeProcessId\":\"\",\"transformUuid\":\"1730885202858\",\"transformed\":true,\"transformDagHash\":0,\"enforceShareCdc\":true,\"pageVersion\":\"1730885195827\",\"dag\":{\"edges\":[],\"nodes\":[]},\"shareCache\":false,\"canOpenInspect\":false,\"isAutoInspect\":false,\"creator\":\"admin@admin.com\",\"showInspectTips\":false,\"alarmSettings\":[{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_STATUS_ERROR\",\"sort\":1,\"notify\":[\"SYSTEM\",\"EMAIL\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_FULL_COMPLETE\",\"sort\":3,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_INCREMENT_START\",\"sort\":4,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_INCREMENT_DELAY\",\"sort\":6,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"}],\"alarmRules\":[{\"key\":\"TASK_INCREMENT_DELAY\",\"point\":60,\"equalsFlag\":1,\"ms\":60000}],\"testTaskId\":\"66fa6374f4a38202d0ac65ce\",\"transformTaskId\":\"66fa6374f4a38202d0ac65cf\",\"stopRetryTimes\":0,\"delayTime\":0,\"doubleActive\":false,\"errorEvents\":[{\"id\":\"6704b527a52d08e5360374d7\",\"message\":\"java.lang.NullPointerException\",\"code\":\"11016\",\"skip\":false},{\"id\":\"67079366a276dd483b17044a\",\"message\":\"Unknown PDK exception occur, java.lang.RuntimeException: Find schema failed, message: Table name \\\"a22f85d3-096e-4656-a7fb-6370008faeff\\\" not exists, qualified name: null tableNameAndQualifiedNameMap: {POLICY=PN_a22f85d3-096e-4656-a7fb-6370008faeff}\",\"code\":\"18001\",\"skip\":false},{\"id\":\"671a2f087962bf68901c9875\",\"message\":\"java.lang.NullPointerException\",\"code\":\"37002\",\"skip\":false}],\"oldVersionTimezone\":false,\"timeDifference\":0,\"autoInspect\":false,\"testTask\":false,\"cdctask\":false,\"snapShotInterrupt\":false,\"previewTask\":false,\"deduceSchemaTask\":false,\"normalTask\":true,\"_deleted\":false,\"createTime\":\"2024-09-30T08:38:12.742+00:00\",\"last_updated\":\"2024-11-06T09:26:43.023+00:00\",\"user_id\":\"62bc5008d4958d013d97c7a6\"}";
			List<String> includeNodeIds = new ArrayList<>();
			doAnswer(invocationOnMock -> null).when(taskPreviewService).previewPrivate(any(), any());
			doAnswer(invocationOnMock -> null).when(taskPreviewService).clearAfterPreview(any());
			TaskPreviewResultVO taskPreviewResultVO = assertDoesNotThrow(() -> taskPreviewService.preview(taskJson, includeNodeIds, 1));
			assertEquals(200, taskPreviewResultVO.getCode());
			assertNull(taskPreviewResultVO.getErrorMsg());
			assertNull(taskPreviewResultVO.getStats());
		}
	}

	@Nested
	@DisplayName("Method previewPrivate test")
	class previewPrivateTest {

		@Test
		@DisplayName("test main process")
		void test1() {
			String taskJson = "{\"id\":\"66fa6374f4a38202d0ac65d0\",\"lastUpdBy\":\"62bc5008d4958d013d97c7a6\",\"createUser\":\"admin@admin.com\",\"permissionActions\":[\"View\",\"Edit\",\"Delete\",\"Reset\",\"Start\",\"Stop\"],\"deduplicWriteMode\":\"intelligent\",\"desc\":\"\",\"increHysteresis\":false,\"increOperationMode\":false,\"increSyncConcurrency\":false,\"processorThreadNum\":1,\"increaseReadSize\":1,\"readBatchSize\":500,\"writeBatchSize\":0,\"writeBatchWaitMs\":0,\"isAutoCreateIndex\":true,\"isFilter\":false,\"isOpenAutoDDL\":false,\"isSchedule\":false,\"isStopOnError\":true,\"name\":\"preview\",\"shareCdcEnable\":false,\"statuses\":[],\"status\":\"edit\",\"type\":\"initial_sync+cdc\",\"writeThreadSize\":8,\"editVersion\":\"1730886537373\",\"syncType\":\"sync\",\"transformProcess\":0,\"listtags\":[{\"id\":\"66ed36f0ef65292a71d427dd\",\"value\":\"preview\"}],\"planStartDateFlag\":false,\"accessNodeType\":\"AUTOMATIC_PLATFORM_ALLOCATION\",\"accessNodeProcessIdList\":[],\"accessNodeProcessId\":\"\",\"transformUuid\":\"1730886537384\",\"transformed\":true,\"transformDagHash\":0,\"enforceShareCdc\":true,\"pageVersion\":\"1730886507146\",\"dag\":{\"edges\":[{\"disabled\":false,\"source\":\"624e868d-419a-4693-9b71-e50c59b86bbf\",\"target\":\"7610a5af-7231-420b-a915-3ee01854b16c\"}],\"nodes\":[{\"tableName\":\"POLICY\",\"isFilter\":false,\"maxTransactionDuration\":12,\"existDataProcessMode\":\"keepData\",\"xmlIncludeFile\":false,\"esFragmentNum\":3,\"nodeConfig\":{\"hashSplit\":false,\"maxSplit\":20,\"batchReadThreadSize\":4},\"cdcMode\":\"logCdc\",\"cdcPollingFields\":[{\"field\":\"\",\"defaultValue\":\"\"}],\"cdcPollingInterval\":500,\"cdcPollingBatchSize\":1000,\"enableCustomCommand\":false,\"incrementExactlyOnceEnableTimeWindowDay\":3,\"connectionId\":\"6641e5fcdea40f2b5753b2e2\",\"databaseType\":\"Mysql\",\"ddlConfiguration\":\"FILTER\",\"readBatchSize\":100,\"increaseReadSize\":1,\"writeStrategy\":\"updateOrInsert\",\"type\":\"table\",\"catalog\":\"data\",\"isTransformed\":false,\"alarmSettings\":[{\"type\":\"DATANODE\",\"open\":true,\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"sort\":4,\"notify\":[\"SYSTEM\",\"EMAIL\"],\"interval\":300,\"unit\":\"SECOND\"}],\"alarmRules\":[{\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"point\":12,\"equalsFlag\":1,\"ms\":5000}],\"id\":\"624e868d-419a-4693-9b71-e50c59b86bbf\",\"name\":\"POLICY\",\"elementType\":\"Node\",\"attrs\":{\"position\":[50,50],\"connectionName\":\"mysql local INSURANCE\",\"connectionType\":\"source_and_target\",\"accessNodeProcessId\":\"\",\"pdkType\":\"pdk\",\"pdkHash\":\"a5af410b12afca476edf4a650c133ddf135bf76542a67787ed6f7f7d53ba712\",\"capabilities\":[{\"type\":11,\"id\":\"run_raw_command_function\"},{\"type\":11,\"id\":\"execute_command_function\"},{\"type\":11,\"id\":\"batch_read_function\"},{\"type\":11,\"id\":\"stream_read_function\"},{\"type\":11,\"id\":\"batch_count_function\"},{\"type\":11,\"id\":\"timestamp_to_stream_offset_function\"},{\"type\":11,\"id\":\"write_record_function\"},{\"type\":11,\"id\":\"query_by_advance_filter_function\"},{\"type\":11,\"id\":\"create_table_v2_function\"},{\"type\":11,\"id\":\"clear_table_function\"},{\"type\":11,\"id\":\"drop_table_function\"},{\"type\":11,\"id\":\"create_index_function\"},{\"type\":11,\"id\":\"query_indexes_function\"},{\"type\":11,\"id\":\"alter_field_attributes_function\"},{\"type\":11,\"id\":\"alter_field_name_function\"},{\"type\":11,\"id\":\"drop_field_function\"},{\"type\":11,\"id\":\"new_field_function\"},{\"type\":11,\"id\":\"count_by_partition_filter_function\"},{\"type\":11,\"id\":\"transaction_begin_function\"},{\"type\":11,\"id\":\"transaction_commit_function\"},{\"type\":11,\"id\":\"transaction_rollback_function\"},{\"type\":11,\"id\":\"get_table_info_function\"},{\"type\":11,\"id\":\"get_table_names_function\"},{\"type\":11,\"id\":\"error_handle_function\"},{\"type\":20,\"id\":\"dml_insert_policy\",\"alternatives\":[\"update_on_exists\",\"ignore_on_exists\",\"just_insert\"]},{\"type\":20,\"id\":\"dml_update_policy\",\"alternatives\":[\"ignore_on_nonexists\",\"insert_on_nonexists\"]},{\"type\":20,\"id\":\"api_server_supported\"},{\"type\":20,\"id\":\"source_incremental_update_event_have_before\"},{\"type\":20,\"id\":\"illegal_date_acceptable\"},{\"type\":20,\"id\":\"batch_read_hash_split\"},{\"type\":10,\"id\":\"new_field_event\"},{\"type\":10,\"id\":\"alter_field_name_event\"},{\"type\":10,\"id\":\"alter_field_attributes_event\"},{\"type\":10,\"id\":\"drop_field_event\"}],\"hasCreated\":false,\"accessNodeType\":\"AUTOMATIC_PLATFORM_ALLOCATION\"},\"disabled\":false},{\"tableName\":\"POLICY\",\"isFilter\":false,\"maxTransactionDuration\":12,\"existDataProcessMode\":\"keepData\",\"updateConditionFields\":[\"POLICY_ID\"],\"xmlIncludeFile\":false,\"esFragmentNum\":3,\"nodeConfig\":{\"syncIndex\":false,\"enableSaveDeleteData\":false,\"writeConcern\":\"w1\",\"shardCollection\":false,\"timeSeriesCollection\":false},\"cdcPollingInterval\":0,\"cdcPollingBatchSize\":0,\"enableCustomCommand\":false,\"incrementExactlyOnceEnableTimeWindowDay\":3,\"connectionId\":\"664c54f0601f4619dacca07b\",\"databaseType\":\"MongoDB\",\"dmlPolicy\":{\"insertPolicy\":\"update_on_exists\",\"updatePolicy\":\"ignore_on_nonexists\"},\"concurrentWritePartitionMap\":{},\"readBatchSize\":500,\"increaseReadSize\":1,\"writeBatchSize\":100,\"writeBatchWaitMs\":500,\"writeStrategy\":\"updateOrInsert\",\"uniqueIndexEnable\":true,\"noPkSyncMode\":\"ADD_HASH\",\"type\":\"table\",\"catalog\":\"data\",\"isTransformed\":false,\"alarmSettings\":[{\"type\":\"DATANODE\",\"open\":true,\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"sort\":4,\"notify\":[\"SYSTEM\",\"EMAIL\"],\"interval\":300,\"unit\":\"SECOND\"}],\"alarmRules\":[{\"key\":\"DATANODE_AVERAGE_HANDLE_CONSUME\",\"point\":12,\"equalsFlag\":1,\"ms\":5000}],\"id\":\"7610a5af-7231-420b-a915-3ee01854b16c\",\"name\":\"POLICY\",\"elementType\":\"Node\",\"attrs\":{\"position\":[334,50],\"connectionName\":\"mongo local target\",\"connectionType\":\"source_and_target\",\"accessNodeProcessId\":\"\",\"pdkType\":\"pdk\",\"pdkHash\":\"4335aaa005ec1a74a4e2166bded2962e939ad50239f48b023b884f35b54129a5\",\"capabilities\":[{\"type\":20,\"id\":\"source_incremental_update_event_have_before\"},{\"type\":11,\"id\":\"execute_command_function\"},{\"type\":11,\"id\":\"batch_read_function\"},{\"type\":11,\"id\":\"stream_read_function\"},{\"type\":11,\"id\":\"batch_count_function\"},{\"type\":11,\"id\":\"timestamp_to_stream_offset_function\"},{\"type\":11,\"id\":\"write_record_function\"},{\"type\":11,\"id\":\"query_by_advance_filter_function\"},{\"type\":11,\"id\":\"create_table_v2_function\"},{\"type\":11,\"id\":\"drop_table_function\"},{\"type\":11,\"id\":\"create_index_function\"},{\"type\":11,\"id\":\"query_indexes_function\"},{\"type\":11,\"id\":\"count_by_partition_filter_function\"},{\"type\":11,\"id\":\"get_read_partitions_function\"},{\"type\":11,\"id\":\"query_field_min_max_value_function\"},{\"type\":11,\"id\":\"get_table_info_function\"},{\"type\":11,\"id\":\"get_table_names_function\"},{\"type\":11,\"id\":\"error_handle_function\"},{\"type\":20,\"id\":\"master_slave_merge\"},{\"type\":20,\"id\":\"dynamic_schema\"},{\"type\":20,\"id\":\"dml_insert_policy\",\"alternatives\":[\"update_on_exists\",\"ignore_on_exists\"]},{\"type\":20,\"id\":\"dml_update_policy\",\"alternatives\":[\"ignore_on_nonexists\",\"insert_on_nonexists\",\"log_on_nonexists\"]},{\"type\":20,\"id\":\"api_server_supported\"}],\"db_version\":\"7.0.5\",\"hasCreated\":true,\"accessNodeType\":\"AUTOMATIC_PLATFORM_ALLOCATION\"},\"disabled\":false}]},\"shareCache\":false,\"canOpenInspect\":false,\"isAutoInspect\":false,\"creator\":\"admin@admin.com\",\"showInspectTips\":false,\"alarmSettings\":[{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_STATUS_ERROR\",\"sort\":1,\"notify\":[\"SYSTEM\",\"EMAIL\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_FULL_COMPLETE\",\"sort\":3,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_INCREMENT_START\",\"sort\":4,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"},{\"type\":\"TASK\",\"open\":true,\"key\":\"TASK_INCREMENT_DELAY\",\"sort\":6,\"notify\":[\"SYSTEM\"],\"interval\":300,\"unit\":\"SECOND\"}],\"alarmRules\":[{\"key\":\"TASK_INCREMENT_DELAY\",\"point\":60,\"equalsFlag\":1,\"ms\":60000}],\"testTaskId\":\"66fa6374f4a38202d0ac65ce\",\"transformTaskId\":\"66fa6374f4a38202d0ac65cf\",\"stopRetryTimes\":0,\"delayTime\":0,\"doubleActive\":false,\"errorEvents\":[{\"id\":\"6704b527a52d08e5360374d7\",\"message\":\"java.lang.NullPointerException\",\"code\":\"11016\",\"skip\":false},{\"id\":\"67079366a276dd483b17044a\",\"message\":\"Unknown PDK exception occur, java.lang.RuntimeException: Find schema failed, message: Table name \\\"a22f85d3-096e-4656-a7fb-6370008faeff\\\" not exists, qualified name: null tableNameAndQualifiedNameMap: {POLICY=PN_a22f85d3-096e-4656-a7fb-6370008faeff}\",\"code\":\"18001\",\"skip\":false},{\"id\":\"671a2f087962bf68901c9875\",\"message\":\"java.lang.NullPointerException\",\"code\":\"37002\",\"skip\":false}],\"oldVersionTimezone\":false,\"timeDifference\":0,\"autoInspect\":false,\"testTask\":false,\"cdctask\":false,\"snapShotInterrupt\":false,\"previewTask\":false,\"deduceSchemaTask\":false,\"normalTask\":true,\"_deleted\":false,\"createTime\":\"2024-09-30T08:38:12.742+00:00\",\"last_updated\":\"2024-11-06T09:48:57.537+00:00\",\"user_id\":\"62bc5008d4958d013d97c7a6\"}";
			try (
					MockedStatic<BeanUtil> beanUtilMockedStatic = mockStatic(BeanUtil.class)
			) {
				HazelcastTaskService hazelcastTaskService = mock(HazelcastTaskService.class);
				TaskClient<TaskDto> taskClient = mock(TaskClient.class);
				when(taskClient.stop()).thenReturn(true);
				when(hazelcastTaskService.startPreviewTask(any())).thenReturn(taskClient);
				beanUtilMockedStatic.when(() -> BeanUtil.getBean(HazelcastTaskService.class)).thenReturn(hazelcastTaskService);
				doAnswer(invocationOnMock -> null).when(taskPreviewService).clearAfterPreview(any());
				TaskPreviewResultVO taskPreviewResultVO = taskPreviewService.preview(taskJson, new ArrayList<>(), 1);
				assertEquals(200, taskPreviewResultVO.getCode());
				assertNotNull(taskPreviewResultVO.getStats());
				assertNull(taskPreviewResultVO.getErrorMsg());
			}
		}
	}
}